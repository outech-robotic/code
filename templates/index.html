<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Outech - PID configurator</title>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I="
            crossorigin="anonymous"></script>
    <style id="dbr"></style>
</head>
<body>
Oublie pas de sauvegarder les coeficients...
<form method="POST" action="{{ url_for('pid_view') }}">
    {{ form.hidden_tag() }}

    <div class="block">
        {% for field in form if field.widget.input_type != 'hidden' %}

        {% if field.errors %}
        <div style="color:red">
            {% endif %}

            {{ field.label }}
            {{ field }}

            {% if form.errors %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
</form>
<hr>
<form method="POST" action="{{ url_for('order_view') }}">
    {{ form.hidden_tag() }}

    <div class="block">
        {% for field in order_form if field.widget.input_type != 'hidden' %}
        {{ field.label }} {{ field }}<br/>
        {% endfor %}
    </div>
</form>
<hr>
<button id="startStopButton">{{ 'Stop' if capture else 'Start' }} capture</button>
<button id="stop_button"><img
        style="width: 25%"
        src="https://www.cdiscount.com/pdt2/6/7/5/1/550x550/fie3700804174675/rw/lampe-gyrophare-projecteur-rouge-rotatif-effet-pom.jpg"/>
</button>
<hr>
<div id="left" style="width:99%; height: 500px; display:inline-block"></div>
<div id="right" style="width:99%; height: 500px; display:inline-block"></div>

<script>
    var turn = 0;
    var doABarrelRoll = function () {
        turn++;
        document.getElementById("dbr").remove();
        var a = "-webkit-", b = 'transform:rotate(' + turn + 'turn);', c = 'transition:1s;';
        document.head.innerHTML += '<style id="dbr">body{' + a + b + a + c + b + c
    };

    window.onload = function () {

        function buildDataSeries(name, color, lineDashType) {
            var dataSeries = {
                type: "line",
                markerSize: 0,
                lineColor: color,
                lineDashType: lineDashType,
                showInLegend: true,
                name: "speed-" + name,
                legendMarkerColor: color,
            };
            dataSeries.dataPoints = [];

            function addPoint(x, y) {
                dataSeries.dataPoints.push({
                    x: x,
                    y: y,
                });
            }

            function clear() {
                dataSeries.dataPoints.length = 0;
            }

            return [dataSeries, clear, addPoint];
        }

        function createGraph(name, color1, color2) {
            var [dataSeriesSpeed, clearSpeed, addSpeed] = buildDataSeries("speed_" + name, color1, "solid");
            var [dataSeriesSetpointSpeed, clearSetpointSpeed, addSetpointSpeed] = buildDataSeries("speed_" + name, "dark" + color1, "longDash");
            var [dataSeriesPos, clearPos, addPos] = buildDataSeries("pos_" + name, color2, "solid");
            var [dataSeriesSetpointPos, clearSetpointPos, addSetpointPos] = buildDataSeries("pos_" + name, "dark" + color2, "longDash");

            var chart = new CanvasJS.Chart(name, {
                zoomEnabled: true,
                animationEnabled: false,
                title: {
                    text: name,
                },

                axisY: {
                    title: "position",
                    includeZero: false,
                    lineThickness: 1
                },
                axisY2: {
                    title: "speed",
                    includeZero: false,
                    lineThickness: 1,
                },
                data: [
                    dataSeriesSetpointSpeed,
                    dataSeriesSpeed,
                    dataSeriesSetpointPos,
                    dataSeriesPos,
                ],
            });

            setInterval(renderChart, 1000 / 60); // 60 FPS in yo eyes.
            function renderChart() {
                chart.render()
            }

            var firstSpeedX = undefined;
            function addSpeedPoint(x, y, setpoint) {
                if (firstSpeedX === undefined) {
                    firstSpeedX = x;
                }
                addSetpointSpeed(x - firstSpeedX, setpoint);
                addSpeed(x - firstSpeedX, y);
            }

            var firstPosX = undefined;

            function addPosPoint(x, y, setpoint) {
                if (firstPosX === undefined) {
                    firstPosX = x;
                }
                addSetpointPos(x - firstPosX, setpoint);
                addPos(x - firstPosX, y);
            }

            function clear() {
                clearSetpointPos();
                clearPos();
                clearSetpointSpeed();
                clearSpeed();

                chart.render()
            }

            return [addSpeedPoint, addPosPoint, clear];
        }

        var [addPointLeftSpeedChart, addPointLeftPosChart, clearLeftSpeedChart] = createGraph("left", "blue", "green");
        var [addPointRightSpeedChart, addPointRightPosChart, clearRightSpeedChart] = createGraph("right", "red", "orange");

        var capture = {{ 'true' if capture else 'false' }};
        var button = document.getElementById("startStopButton")
        button.onclick = function () {
            capture = !capture;
            if (capture) {
                button.innerText = "Stop capture";
                clearLeftSpeedChart();
                clearRightSpeedChart();
            } else {
                button.innerText = "Start capture"
            }
        };

        var socket = io.connect(null, {rememberTransport: false});
        var stop_button = document.getElementById("stop_button");
        var soundPath = 'https://www.myinstants.com/media/sounds/peproll1.mp3';
        var sound = new Audio(soundPath);
        stop_button.onclick = function () {
            socket.emit("STOP", null);
            doABarrelRoll();
            sound.play();
        };
        socket.on('pos_left', function (msg) {
            if (!capture) {
                return
            }
            addPointLeftPosChart(msg[0], msg[1], msg[2])
        });
        socket.on('pos_right', function (msg) {
            if (!capture) {
                return
            }
            addPointRightPosChart(msg[0], msg[1], msg[2])
        });
        socket.on('speed_left', function (msg) {
            if (!capture) {
                return
            }
            addPointLeftSpeedChart(msg[0], msg[1], msg[2])
        });
        socket.on('speed_right', function (msg) {
            if (!capture) {
                return
            }
            addPointRightSpeedChart(msg[0], msg[1], msg[2])
        });

    }
</script>
</body>

</html>
